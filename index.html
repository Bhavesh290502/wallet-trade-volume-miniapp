<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wallet Trade Volume MiniApp</title>
  <meta name="fc:miniapp" content="true" />

  <style>
    :root{
      --bg:#071028; --card:#071425; --muted:#9fb0c9; --accent:#6d28d9;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{
      display:grid;place-items:center;
      background:linear-gradient(180deg,#041024 0%, #071a30 100%);
      color:#e6eef6;padding:20px;
    }
    .card{width:100%;max-width:820px;background:rgba(255,255,255,0.02);border-radius:14px;padding:28px;box-shadow:0 10px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .grid{display:flex;gap:12px;flex-wrap:wrap}
    .stat{flex:1 1 220px;background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;min-width:180px}
    .stat .label{color:var(--muted);font-size:13px}
    .stat .num{font-weight:700;font-size:18px;margin-top:6px}
    .actions{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    button{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:700;background:linear-gradient(90deg,var(--accent),#7c3aed);color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    small.note{display:block;color:var(--muted);margin-top:10px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:560px){ .grid{flex-direction:column} }
  </style>
</head>
<body>
  <div class="card" id="app">
    <h1>Wallet Trade Volume MiniApp</h1>
    <p class="lead">Connect your wallet (via Farcaster host or browser wallet). This app calculates **total DEX trade volume (USD)** for the connected wallet and lets you share it to Farcaster.</p>

    <div class="grid">
      <div class="stat">
        <div class="label">Connected address</div>
        <div id="addr" class="num">—</div>
        <small id="chain" class="note">chain: —</small>
      </div>

      <div class="stat">
        <div class="label">Native balance</div>
        <div id="balanceNative" class="num">—</div>
        <small id="balanceNote" class="note">native token</small>
      </div>

      <div class="stat">
        <div class="label">Total DEX trade volume (USD)</div>
        <div id="tradeVolume" class="num">—</div>
        <small id="volumeNote" class="note">computed via server (Bitquery)</small>
      </div>
    </div>

    <div class="actions">
      <button id="connectBtn">Connect / Refresh</button>
      <button id="shareBtn" class="ghost" disabled>Share to Farcaster</button>
    </div>

    <small class="note">If you open this page outside a Farcaster host, the Share button will show a fallback prompt.</small>

    <footer><small>Implements <code>sdk.actions.ready()</code> after UI paint; all actions are wired after SDK handshake.</small></footer>
  </div>

  <!-- SDK import from UNPKG (ESM). Note the ?module flag to ensure an ESM bundle. -->
  <script type="module">
    import { sdk } from "https://unpkg.com/@farcaster/miniapp-sdk?module";

    const $ = id => document.getElementById(id);
    const addrEl = $('addr');
    const chainEl = $('chain');
    const balanceNativeEl = $('balanceNative');
    const tradeVolumeEl = $('tradeVolume');
    const connectBtn = $('connectBtn');
    const shareBtn = $('shareBtn');

    let provider = null;
    let userAddress = null;
    let chainId = null;
    let isInMiniApp = false;
    let latestNativeBalanceHex = null;
    let latestVolumeUsd = null;

    function formatEthFromHex(weiHex) {
      if (!weiHex) return '—';
      try {
        const w = BigInt(weiHex);
        const base = 10n ** 18n;
        const whole = w / base;
        const rem = w % base;
        const decimals = rem.toString().padStart(18,'0').slice(0,6);
        return `${whole.toString()}.${decimals}`;
      } catch (e) { return 'N/A' }
    }

    async function init() {
      // 1) detect host
      isInMiniApp = typeof sdk?.isInMiniApp === 'function' ? sdk.isInMiniApp() : false;

      // Wait for paint so UI shows quickly
      await new Promise(r => requestAnimationFrame(r));

      try {
        if (sdk?.actions?.ready) {
          await sdk.actions.ready();
          console.debug('Called sdk.actions.ready()');
        } else {
          console.warn('sdk.actions.ready() not available on sdk');
        }
      } catch (err) {
        console.error('Error calling sdk.actions.ready():', err);
      }

      // Wire UI actions AFTER handshake
      connectBtn.addEventListener('click', onConnectClick);
      shareBtn.addEventListener('click', onShareClick);

      // Optionally auto-connect when in miniapp
      if (isInMiniApp) {
        await onConnectClick();
      } else {
        // Not in host: enable Connect so user can test with MetaMask or other injected provider.
        connectBtn.disabled = false;
      }
    }

    async function onConnectClick() {
      connectBtn.disabled = true;
      connectBtn.textContent = 'Connecting...';
      try {
        // Get provider from SDK if available; else fallback to window.ethereum
        if (sdk?.wallet?.getEthereumProvider) {
          provider = await sdk.wallet.getEthereumProvider();
        } else if (window.ethereum) {
          provider = window.ethereum;
        } else {
          provider = null;
        }

        if (!provider) {
          addrEl.textContent = 'No provider';
          balanceNativeEl.textContent = '—';
          tradeVolumeEl.textContent = '—';
          chainEl.textContent = 'chain: —';
          return;
        }

        // Request accounts
        let accounts = [];
        try {
          accounts = await provider.request({ method: 'eth_requestAccounts', params: [] });
        } catch (err) {
          try { accounts = await provider.request({ method: 'eth_accounts' }); } catch(e){ accounts = [] }
        }
        userAddress = accounts && accounts.length ? accounts[0] : null;
        if (!userAddress) {
          addrEl.textContent = 'No address';
          balanceNativeEl.textContent = '—';
          tradeVolumeEl.textContent = '—';
          return;
        }
        addrEl.textContent = userAddress;

        // chain id
        try {
          const cid = await provider.request({ method: 'eth_chainId', params: [] });
          chainId = cid;
          chainEl.textContent = `chain: ${cid}`;
        } catch (e) {
          chainEl.textContent = 'chain: unknown';
        }

        // native balance
        let balHex = null;
        try {
          balHex = await provider.request({ method: 'eth_getBalance', params: [userAddress, 'latest'] });
          latestNativeBalanceHex = balHex;
          balanceNativeEl.textContent = `${formatEthFromHex(balHex)} native`;
        } catch (e) {
          balanceNativeEl.textContent = 'balance: error';
        }

        // fetch total trade volume (USD) from server
        try {
          const resp = await fetch(`/api/volume?address=${encodeURIComponent(userAddress)}&chain=eth`);
          if (!resp.ok) {
            const err = await resp.text().catch(()=>null);
            console.error('volume API returned error', resp.status, err);
            tradeVolumeEl.textContent = 'error';
            latestVolumeUsd = null;
          } else {
            const j = await resp.json();
            const v = Number(j.volumeUsd || 0);
            latestVolumeUsd = v;
            tradeVolumeEl.textContent = `$${v.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
          }
        } catch (e) {
          console.error('fetch volume failed', e);
          tradeVolumeEl.textContent = 'error';
          latestVolumeUsd = null;
        }

        // Enable Share only when inside the Farcaster host (composeCast works there)
        if (isInMiniApp && sdk?.actions?.composeCast) {
          shareBtn.disabled = false;
          shareBtn.classList.remove('ghost');
          shareBtn.textContent = 'Share to Farcaster';
        } else {
          shareBtn.disabled = false;
          shareBtn.classList.add('ghost');
          shareBtn.textContent = 'Open in Farcaster to Share';
        }

      } catch (err) {
        console.error('connect error', err);
        addrEl.textContent = 'error';
        balanceNativeEl.textContent = '—';
        tradeVolumeEl.textContent = '—';
      } finally {
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect / Refresh';
      }
    }

    async function onShareClick() {
      // Compose a dynamic message
      if (isInMiniApp && sdk?.actions?.composeCast) {
        const volumeText = latestVolumeUsd !== null ? `$${latestVolumeUsd.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}` : 'N/A';
        const text = `Checked my wallet ${userAddress} — total DEX trade volume: ${volumeText} (via Wallet Trade Volume MiniApp).`;
        try {
          await sdk.actions.composeCast({ text });
        } catch (err) {
          console.error('composeCast failed', err);
          alert('Failed to open Farcaster composer.');
        }
      } else {
        alert('Open this page inside Farcaster (Warpcast) to share directly.');
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
